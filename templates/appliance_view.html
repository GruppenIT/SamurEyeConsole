{% extends "base.html" %}
{% block title %}{{ appliance.name }} - SamurEye Cloud{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.min.css" />
<style>
#terminal-container {
    background-color: #1a1a2e;
    border-radius: 8px;
    padding: 10px;
    display: none;
}
#terminal {
    height: 400px;
}
.terminal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 12px;
    background: #16213e;
    border-radius: 8px 8px 0 0;
    color: #fff;
}
.terminal-status {
    display: flex;
    align-items: center;
    gap: 8px;
}
.terminal-status-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: #dc3545;
}
.terminal-status-dot.connected {
    background: #28a745;
}
.tunnel-badge {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 0.85em;
    font-weight: 500;
}
.tunnel-connected {
    background: rgba(40, 167, 69, 0.2);
    color: #28a745;
}
.tunnel-disconnected {
    background: rgba(220, 53, 69, 0.2);
    color: #dc3545;
}
</style>
{% endblock %}

{% block content %}
<nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('contracts') }}">Contratos</a></li>
        <li class="breadcrumb-item"><a href="{{ url_for('view_contract', id=appliance.contract.id) }}">{{ appliance.contract.client_name }}</a></li>
        <li class="breadcrumb-item active">{{ appliance.name }}</li>
    </ol>
</nav>

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h4 class="mb-1">{{ appliance.name }}</h4>
        <small class="text-muted">{{ appliance.description or 'Sem descricao' }}</small>
    </div>
    <div>
        {% if appliance.is_active %}
            <span class="status-badge status-active me-2">Ativo</span>
        {% else %}
            <span class="status-badge status-inactive me-2">Desativado</span>
        {% endif %}
        <span id="tunnel-status" class="tunnel-badge {% if is_tunnel_connected %}tunnel-connected{% else %}tunnel-disconnected{% endif %}">
            <span class="terminal-status-dot {% if is_tunnel_connected %}connected{% endif %}"></span>
            <span id="tunnel-status-text">{% if is_tunnel_connected %}Tunel Conectado{% else %}Tunel Desconectado{% endif %}</span>
        </span>
        <a href="{{ url_for('edit_appliance', id=appliance.id) }}" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-pencil"></i> Editar
        </a>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-key me-2"></i>Token de Autenticacao
            </div>
            <div class="card-body">
                <div class="token-display mb-3">{{ appliance.token }}</div>
                <form action="{{ url_for('reset_appliance_token', id=appliance.id) }}" method="POST" class="d-inline"
                      onsubmit="return confirm('Tem certeza? O appliance precisara ser reconfigurado com o novo token.')">
                    <button type="submit" class="btn btn-warning btn-sm">
                        <i class="bi bi-arrow-clockwise"></i> Resetar Token
                    </button>
                </form>
                <button class="btn btn-outline-secondary btn-sm" onclick="copyToken()">
                    <i class="bi bi-clipboard"></i> Copiar
                </button>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-info-circle me-2"></i>Informacoes
            </div>
            <div class="card-body">
                <table class="table table-borderless table-sm mb-0">
                    <tr>
                        <td class="text-muted">Cliente:</td>
                        <td>{{ appliance.contract.client_name }}</td>
                    </tr>
                    <tr>
                        <td class="text-muted">Contrato:</td>
                        <td>{{ appliance.contract.start_date.strftime('%d/%m/%Y') }} - {{ appliance.contract.end_date.strftime('%d/%m/%Y') }}</td>
                    </tr>
                    <tr>
                        <td class="text-muted">Ultima Atividade:</td>
                        <td>
                            {% if appliance.last_seen %}
                                {{ (appliance.last_seen|to_brazil_tz).strftime('%d/%m/%Y %H:%M:%S') }}
                            {% else %}
                                <span class="text-muted">Nunca conectou</span>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td class="text-muted">Criado em:</td>
                        <td>{{ (appliance.created_at|to_brazil_tz).strftime('%d/%m/%Y %H:%M') }}</td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header">
        <i class="bi bi-pc-display me-2"></i>Inventario do Sistema
    </div>
    <div class="card-body">
        {% if appliance.inventory_updated_at %}
        <div class="row">
            <div class="col-md-6">
                <table class="table table-borderless table-sm mb-0">
                    <tr>
                        <td class="text-muted" style="width: 140px;">Endereco IP:</td>
                        <td><code>{{ appliance.ip_address or '-' }}</code></td>
                    </tr>
                    <tr>
                        <td class="text-muted">Hostname:</td>
                        <td><strong>{{ appliance.hostname or '-' }}</strong></td>
                    </tr>
                    <tr>
                        <td class="text-muted">Tecnologia:</td>
                        <td>{{ appliance.virtualization or '-' }}</td>
                    </tr>
                    <tr>
                        <td class="text-muted">Sistema Operacional:</td>
                        <td>{{ appliance.os_distribution or '-' }} {{ appliance.os_version or '' }}</td>
                    </tr>
                </table>
            </div>
            <div class="col-md-6">
                <table class="table table-borderless table-sm mb-0">
                    <tr>
                        <td class="text-muted" style="width: 140px;">vCPUs:</td>
                        <td>{{ appliance.vcpus or '-' }}</td>
                    </tr>
                    <tr>
                        <td class="text-muted">Memoria:</td>
                        <td>{{ "%.1f"|format(appliance.memory_gb or 0) }} GB</td>
                    </tr>
                    <tr>
                        <td class="text-muted">Disco:</td>
                        <td>{{ "%.1f"|format(appliance.disk_gb or 0) }} GB</td>
                    </tr>
                    <tr>
                        <td class="text-muted">Atualizado em:</td>
                        <td>{{ (appliance.inventory_updated_at|to_brazil_tz).strftime('%d/%m/%Y %H:%M') }}</td>
                    </tr>
                </table>
            </div>
        </div>
        {% else %}
        <p class="text-muted text-center mb-0">Aguardando dados de inventario do appliance...</p>
        {% endif %}
    </div>
</div>

<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-terminal me-2"></i>Acesso Remoto</span>
        <div>
            <button id="btn-connect-shell" class="btn btn-success btn-sm" onclick="connectShell()" {% if not is_tunnel_connected %}disabled{% endif %}>
                <i class="bi bi-terminal"></i> Conectar Shell
            </button>
            <button id="btn-disconnect-shell" class="btn btn-danger btn-sm" onclick="disconnectShell()" style="display: none;">
                <i class="bi bi-stop-fill"></i> Desconectar Shell
            </button>
        </div>
    </div>
    <div class="card-body p-0">
        <div id="terminal-container">
            <div id="terminal"></div>
        </div>
        <div id="terminal-placeholder" class="text-center py-5">
            <i class="bi bi-terminal" style="font-size: 3rem; color: #6c757d;"></i>
            <p class="text-muted mt-3" id="terminal-placeholder-text">
                {% if is_tunnel_connected %}
                    Clique em <strong>Conectar Shell</strong> para abrir um terminal de linha de comando.
                {% else %}
                    O appliance nao esta conectado ao tunel. Aguarde a conexao ou verifique o servico de telemetria.
                {% endif %}
            </p>
        </div>
    </div>
</div>

{% if metrics or login_logs or threats %}
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-graph-up me-2"></i>Metricas de Saude ({{ period_options[current_period].label }})</span>
        <div class="btn-group btn-group-sm" role="group">
            {% for key, opt in period_options.items() %}
            <a href="{{ url_for('view_appliance', id=appliance.id, period=key) }}" class="btn {% if current_period == key %}btn-samureye{% else %}btn-outline-secondary{% endif %}">
                {{ opt.label }}
            </a>
            {% endfor %}
        </div>
    </div>
    <div class="card-body">
{% if metrics %}
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="text-center">
                    <h5 class="mb-1">{{ "%.1f"|format(metrics[-1].cpu_percent or 0) }}%</h5>
                    <small class="text-muted">CPU</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    <h5 class="mb-1">{{ "%.1f"|format(metrics[-1].memory_percent or 0) }}%</h5>
                    <small class="text-muted">Memoria</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    <h5 class="mb-1">{{ "%.1f"|format(metrics[-1].disk_percent or 0) }}%</h5>
                    <small class="text-muted">Disco</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    <h5 class="mb-1">{{ "%.2f"|format((metrics[-1].network_bytes_recv_rate or 0) / 1024 / 1024) }} MB/s</h5>
                    <small class="text-muted">Rede (Recv)</small>
                </div>
            </div>
        </div>
        <div class="row mb-3">
            <div class="col-md-6">
                <div class="card border-0 shadow-sm">
                    <div class="card-body p-3">
                        <h6 class="text-muted mb-2"><i class="bi bi-cpu me-1"></i>CPU %</h6>
                        <canvas id="cpuChart" height="150"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card border-0 shadow-sm">
                    <div class="card-body p-3">
                        <h6 class="text-muted mb-2"><i class="bi bi-memory me-1"></i>Memoria %</h6>
                        <canvas id="memoryChart" height="150"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6">
                <div class="card border-0 shadow-sm">
                    <div class="card-body p-3">
                        <h6 class="text-muted mb-2"><i class="bi bi-hdd me-1"></i>Disco %</h6>
                        <canvas id="diskChart" height="150"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card border-0 shadow-sm">
                    <div class="card-body p-3">
                        <h6 class="text-muted mb-2"><i class="bi bi-ethernet me-1"></i>Rede (MB/s)</h6>
                        <canvas id="networkChart" height="150"></canvas>
                    </div>
                </div>
            </div>
        </div>
{% endif %}
    </div>
</div>
{% endif %}

<div class="row">
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-door-open me-2"></i>Logs de Login (SSH/GUI)
            </div>
            <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                {% if login_logs %}
                <table class="table table-sm table-hover" style="table-layout: fixed;">
                    <thead>
                        <tr>
                            <th style="width: 75px;">Data/Hora</th>
                            <th style="width: 45px;">Tipo</th>
                            <th style="width: 70px;">Usuario</th>
                            <th style="width: 95px;">IP</th>
                            <th style="width: 35px; text-align: center;"></th>
                            <th style="width: 30px;"></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for log in login_logs %}
                        <tr>
                            <td style="white-space: nowrap; font-size: 0.85em;">{{ (log.timestamp|to_brazil_tz).strftime('%d/%m %H:%M') }}</td>
                            <td><span class="badge bg-secondary" style="font-size: 0.7em;">{{ log.login_type }}</span></td>
                            <td style="font-size: 0.85em; overflow: hidden; text-overflow: ellipsis;">{{ log.username or '-' }}</td>
                            <td style="font-size: 0.85em;">{{ log.source_ip or '-' }}</td>
                            <td style="text-align: center;">
                                {% if log.success %}
                                    <span class="text-success"><i class="bi bi-check-circle"></i></span>
                                {% else %}
                                    <span class="text-danger"><i class="bi bi-x-circle"></i></span>
                                {% endif %}
                            </td>
                            <td style="text-align: center;">
                                <button type="button" class="btn btn-sm btn-outline-secondary py-0 px-1" data-bs-toggle="modal" data-bs-target="#loginDetailModal{{ log.id }}">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p class="text-muted text-center py-3">Nenhum log de login registrado.</p>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-shield-exclamation me-2"></i>Metadados de Ameacas
            </div>
            <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                {% if threats %}
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Data/Hora</th>
                            <th>Tipo</th>
                            <th>Severidade</th>
                            <th>Origem</th>
                            <th>Qtd</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for threat in threats %}
                        <tr>
                            <td>{{ (threat.timestamp|to_brazil_tz).strftime('%d/%m %H:%M') }}</td>
                            <td>{{ threat.threat_type or '-' }}</td>
                            <td>
                                {% if threat.severity == 'critical' %}
                                    <span class="badge bg-danger">Critico</span>
                                {% elif threat.severity == 'high' %}
                                    <span class="badge bg-warning">Alto</span>
                                {% elif threat.severity == 'medium' %}
                                    <span class="badge bg-info">Medio</span>
                                {% else %}
                                    <span class="badge bg-secondary">Baixo</span>
                                {% endif %}
                            </td>
                            <td>{{ threat.source_ip or '-' }}</td>
                            <td>{{ threat.count }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p class="text-muted text-center py-3">Nenhum metadado de ameaca registrado.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="text-end">
    <form action="{{ url_for('delete_appliance', id=appliance.id) }}" method="POST" class="d-inline"
          onsubmit="return confirm('Tem certeza que deseja remover este appliance? Todos os dados serao perdidos.')">
        <button type="submit" class="btn btn-outline-danger btn-sm">
            <i class="bi bi-trash"></i> Remover Appliance
        </button>
    </form>
</div>

{% for log in login_logs %}
<div class="modal fade" id="loginDetailModal{{ log.id }}" tabindex="-1" aria-labelledby="loginDetailModalLabel{{ log.id }}" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="loginDetailModalLabel{{ log.id }}">
                    <i class="bi bi-door-open me-2"></i>Detalhes do Login
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <table class="table table-borderless">
                    <tr>
                        <th style="width: 140px;">Data/Hora:</th>
                        <td>{{ (log.timestamp|to_brazil_tz).strftime('%d/%m/%Y %H:%M:%S') }}</td>
                    </tr>
                    <tr>
                        <th>Tipo:</th>
                        <td><span class="badge bg-secondary">{{ log.login_type }}</span></td>
                    </tr>
                    <tr>
                        <th>Usuario:</th>
                        <td>{{ log.username or '-' }}</td>
                    </tr>
                    <tr>
                        <th>IP de Origem:</th>
                        <td>{{ log.source_ip or '-' }}</td>
                    </tr>
                    <tr>
                        <th>Status:</th>
                        <td>
                            {% if log.success %}
                                <span class="badge bg-success">Sucesso</span>
                            {% else %}
                                <span class="badge bg-danger">Falha</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% if log.details %}
                    <tr>
                        <th>Detalhes:</th>
                        <td><pre style="white-space: pre-wrap; font-size: 0.85em; background: #f8f9fa; padding: 8px; border-radius: 4px; margin: 0;">{{ log.details }}</pre></td>
                    </tr>
                    {% endif %}
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>
{% endfor %}
{% endblock %}

{% block extra_js %}
<script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js"></script>
<script>
const applianceId = {{ appliance.id }};
let socket = null;
let term = null;
let fitAddon = null;
let shellConnected = false;

function copyToken() {
    const token = "{{ appliance.token }}";
    navigator.clipboard.writeText(token).then(() => {
        alert('Token copiado!');
    });
}

function updateTunnelStatus() {
    fetch('/api/v1/appliances/' + applianceId + '/tunnel-status')
        .then(response => response.json())
        .then(data => {
            const statusBadge = document.getElementById('tunnel-status');
            const statusText = document.getElementById('tunnel-status-text');
            const statusDot = statusBadge.querySelector('.terminal-status-dot');
            const placeholderText = document.getElementById('terminal-placeholder-text');
            const btnConnectShell = document.getElementById('btn-connect-shell');
            
            if (data.connected) {
                statusBadge.classList.remove('tunnel-disconnected');
                statusBadge.classList.add('tunnel-connected');
                statusDot.classList.add('connected');
                statusText.textContent = 'Tunel Conectado';
                placeholderText.innerHTML = 'Clique em <strong>Conectar Shell</strong> para abrir um terminal de linha de comando.';
                btnConnectShell.disabled = false;
            } else {
                statusBadge.classList.remove('tunnel-connected');
                statusBadge.classList.add('tunnel-disconnected');
                statusDot.classList.remove('connected');
                statusText.textContent = 'Tunel Desconectado';
                placeholderText.textContent = 'O appliance nao esta conectado ao tunel. Aguarde a conexao ou verifique o servico de telemetria.';
                btnConnectShell.disabled = true;
            }
        })
        .catch(err => console.error('Error checking tunnel status:', err));
}

function connectShell() {
    if (shellConnected) return;
    
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    socket = io(window.location.origin + '/console', {
        transports: ['websocket']
    });
    
    socket.on('connect', () => {
        console.log('Console connected');
        
        document.getElementById('terminal-container').style.display = 'block';
        document.getElementById('terminal-placeholder').style.display = 'none';
        document.getElementById('btn-connect-shell').style.display = 'none';
        document.getElementById('btn-disconnect-shell').style.display = 'inline-block';
        
        term = new Terminal({
            cursorBlink: true,
            fontSize: 14,
            fontFamily: 'Menlo, Monaco, "Courier New", monospace',
            theme: {
                background: '#1a1a2e',
                foreground: '#eaeaea',
                cursor: '#e94560'
            }
        });
        
        fitAddon = new FitAddon.FitAddon();
        term.loadAddon(fitAddon);
        term.open(document.getElementById('terminal'));
        fitAddon.fit();
        
        socket.emit('start_shell', {
            appliance_id: applianceId,
            cols: term.cols,
            rows: term.rows
        });
        
        term.onData(data => {
            socket.emit('shell_input', {
                appliance_id: applianceId,
                input: data
            });
        });
        
        term.onResize(size => {
            socket.emit('resize_shell', {
                appliance_id: applianceId,
                cols: size.cols,
                rows: size.rows
            });
        });
        
        window.addEventListener('resize', () => {
            if (fitAddon) fitAddon.fit();
        });
    });
    
    socket.on('shell_started', (data) => {
        shellConnected = true;
        term.writeln('\x1b[32mConectado ao appliance: ' + data.appliance_name + '\x1b[0m');
        term.writeln('');
    });
    
    socket.on('shell_output', (data) => {
        if (term) {
            term.write(data.output);
        }
    });
    
    socket.on('shell_error', (data) => {
        if (term) {
            term.writeln('\x1b[31mErro: ' + data.error + '\x1b[0m');
        }
        disconnectShell();
    });
    
    socket.on('shell_closed', (data) => {
        if (term) {
            term.writeln('');
            term.writeln('\x1b[33mSessao encerrada: ' + (data.reason || 'Conexao fechada') + '\x1b[0m');
        }
        shellConnected = false;
    });
    
    socket.on('disconnect', () => {
        console.log('Console disconnected');
        shellConnected = false;
    });
}

function disconnectShell() {
    if (socket) {
        socket.emit('close_shell', { appliance_id: applianceId });
        socket.disconnect();
        socket = null;
    }
    
    shellConnected = false;
    
    if (term) {
        term.dispose();
        term = null;
    }
    
    document.getElementById('terminal-container').style.display = 'none';
    document.getElementById('terminal-placeholder').style.display = 'block';
    document.getElementById('btn-connect-shell').style.display = 'inline-block';
    document.getElementById('btn-disconnect-shell').style.display = 'none';
}

setInterval(updateTunnelStatus, 10000);
updateTunnelStatus();

{% if metrics %}
{% if current_period in ['7d', '30d', '90d'] %}
const labels = [{% for m in metrics %}"{{ (m.timestamp|to_brazil_tz).strftime('%d/%m') }}"{% if not loop.last %},{% endif %}{% endfor %}];
{% else %}
const labels = [{% for m in metrics %}"{{ (m.timestamp|to_brazil_tz).strftime('%H:%M') }}"{% if not loop.last %},{% endif %}{% endfor %}];
{% endif %}

const areaChartOptions = {
    responsive: true,
    maintainAspectRatio: true,
    plugins: { 
        legend: { display: false }
    },
    scales: { 
        x: {
            grid: { display: false },
            ticks: { maxTicksLimit: 8 }
        },
        y: { 
            beginAtZero: true, 
            max: 100,
            grid: { color: 'rgba(0,0,0,0.05)' }
        } 
    },
    elements: {
        point: { radius: 0, hoverRadius: 4 }
    }
};

new Chart(document.getElementById('cpuChart'), {
    type: 'line',
    data: {
        labels: labels,
        datasets: [{
            label: 'CPU %',
            data: [{% for m in metrics %}{{ m.cpu_percent or 0 }}{% if not loop.last %},{% endif %}{% endfor %}],
            borderColor: '#e94560',
            backgroundColor: 'rgba(233, 69, 96, 0.3)',
            fill: true,
            tension: 0.4,
            borderWidth: 2
        }]
    },
    options: areaChartOptions
});

new Chart(document.getElementById('memoryChart'), {
    type: 'line',
    data: {
        labels: labels,
        datasets: [{
            label: 'Memoria %',
            data: [{% for m in metrics %}{{ m.memory_percent or 0 }}{% if not loop.last %},{% endif %}{% endfor %}],
            borderColor: '#0f3460',
            backgroundColor: 'rgba(15, 52, 96, 0.3)',
            fill: true,
            tension: 0.4,
            borderWidth: 2
        }]
    },
    options: areaChartOptions
});

new Chart(document.getElementById('diskChart'), {
    type: 'line',
    data: {
        labels: labels,
        datasets: [{
            label: 'Disco %',
            data: [{% for m in metrics %}{{ m.disk_percent or 0 }}{% if not loop.last %},{% endif %}{% endfor %}],
            borderColor: '#f39c12',
            backgroundColor: 'rgba(243, 156, 18, 0.3)',
            fill: true,
            tension: 0.4,
            borderWidth: 2
        }]
    },
    options: areaChartOptions
});

new Chart(document.getElementById('networkChart'), {
    type: 'line',
    data: {
        labels: labels,
        datasets: [{
            label: 'Recebido (MB/s)',
            data: [{% for m in metrics %}{{ ((m.network_bytes_recv_rate or 0) / 1024 / 1024)|round(3) }}{% if not loop.last %},{% endif %}{% endfor %}],
            borderColor: '#28a745',
            backgroundColor: 'rgba(40, 167, 69, 0.2)',
            fill: true,
            tension: 0.4,
            borderWidth: 2
        }, {
            label: 'Enviado (MB/s)',
            data: [{% for m in metrics %}{{ ((m.network_bytes_sent_rate or 0) / 1024 / 1024)|round(3) }}{% if not loop.last %},{% endif %}{% endfor %}],
            borderColor: '#17a2b8',
            backgroundColor: 'rgba(23, 162, 184, 0.2)',
            fill: true,
            tension: 0.4,
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: { 
            legend: { 
                display: true,
                position: 'top',
                labels: { boxWidth: 12, padding: 8 }
            }
        },
        scales: { 
            x: {
                grid: { display: false },
                ticks: { maxTicksLimit: 8 }
            },
            y: { 
                beginAtZero: true,
                grid: { color: 'rgba(0,0,0,0.05)' }
            } 
        },
        elements: {
            point: { radius: 0, hoverRadius: 4 }
        }
    }
});
{% endif %}
</script>
{% endblock %}
